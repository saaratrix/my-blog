<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Angular E2E Tests Introduction</title>
</head>
<body>
<p>
    This is an introduction to <strong>Angular E2E tests</strong> with two examples using Angular 10.
    The first example is the default test generated by the Angular 10 CLI and the second test does the following:
</p>
<ol>
    <li>Logs in</li>
    <li>Creates an item</li>
    <li>Modifies the item</li>
    <li>Deletes the item</li>
    <li>Logs out</li>
</ol>
<p>
    Angular uses <a href="https://www.protractortest.org/#/">Protractor</a> to do the e2e tests.
    If you generate a project with the Angular CLI it's very simple to run your e2e tests by simply running <code>ng e2e</code>.
</p>
<p>
    Source code can be found at <a href="https://github.com/saaratrix/angular-e2e-example">https://github.com/saaratrix/angular-e2e-example</a>
</p>
<!--more-->
<div id="toc" class="hide"></div>
<div id="contents">
    <h1>Why should I use E2E tests?</h1>
    <p>
        E2E tests can be useful to automate a sequence of actions or that everything works as it mimics a user browsing the website.
        For example you could have E2E tests that does the most common things like login, interact with something and logout.
        You can then assume that those cases work without having to manually test it yourself every time.
        In the <code>protractor.conf.js</code> file you can set the URL you're testing so you could test directly against your production server.
    </p>
    <h1>The default Angular 10 CLI example</h1>
    <p>
        If you created an angular application using the cli it should look something like in this image:
        <br>
        <a href="https://1.bp.blogspot.com/-cGbLzZ-tAFo/X56qWgonsGI/AAAAAAAAAWo/iQvxj7tftfcXZqErNDyG8IzVsqg5Kg44QCPcBGAYYCw/s731/folder-structure-angular-10.png">
            <img alt="" border="0" height="200" data-original-height="731" data-original-width="481" src="https://1.bp.blogspot.com/-cGbLzZ-tAFo/X56qWgonsGI/AAAAAAAAAWo/iQvxj7tftfcXZqErNDyG8IzVsqg5Kg44QCPcBGAYYCw/s200/folder-structure-angular-10.png"/>
        </a>
        <br>
        The e2e tests goes to the e2e folder.
        If you want a different folder make sure it's included in the <code>protractor.conf.js</code> file.
    </p>
    <h2>Running the tests</h2>
    <p>
        You can run the tests by doing the command <code>ng e2e</code> or <code>npm run e2e</code>.
        A browser will then open that runs the tests.
        <br>
        <a href="https://1.bp.blogspot.com/--CJXfRZxPn0/X56r1ZBxiZI/AAAAAAAAAWw/ARXdAoxtYvMot5NGn-JFXFQ7LjFeda2GwCLcBGAsYHQ/s1004/chrome-automated-notification.png">
            <img alt="" border="0" height="200" data-original-height="1004" data-original-width="923" src="https://1.bp.blogspot.com/--CJXfRZxPn0/X56r1ZBxiZI/AAAAAAAAAWw/ARXdAoxtYvMot5NGn-JFXFQ7LjFeda2GwCLcBGAsYHQ/s200/chrome-automated-notification.png"/>
        </a>
        <br>
    </p>
    <p>
        Running all the tests using <code>ng e2e</code> can be very time consuming for a larger app.
        This is because it has to compile the whole application before running the tests and to start a browser.
        It can also be time consuming because you have many tests or tests that take a lot of time to run.
    </p>
    <p>
        In Webstorm you can drastically reduce the time spent developing E2E tests by running specific tests.
        Webstorm does this by skipping the compiling part and instead uses the <code>ng serve</code> build.
        There might be a similar feature in VS Code or other editors to run a specific test.
        Here's how to run a specific test in Webstorm:
        <br>
        <span style="font-size: 0.55rem; font-style: italic; color: hsl(0,0%,70%)">Yes this is an unsponsored ad for Webstorm!!</span>
    </p>
    <ol>
        <li>
            Run the app normally with <code>ng serve</code>.
            If you don't do ng serve you'll get a message that the website could not be reached when running the test.
        </li>
        <li>
            Click on the green arrow to run as specific test.
            <br>
            <a href="https://1.bp.blogspot.com/-nGk2vt-fhho/X56sairU8CI/AAAAAAAAAW4/Rj7dyDBVd8wP5Je6tdKOhhKgEPPCwUMSwCLcBGAsYHQ/s795/webstorm-runs-specific-test.png">
                <img alt="" border="0" width="200" data-original-height="523" data-original-width="795" src="https://1.bp.blogspot.com/-nGk2vt-fhho/X56sairU8CI/AAAAAAAAAW4/Rj7dyDBVd8wP5Je6tdKOhhKgEPPCwUMSwCLcBGAsYHQ/s200/webstorm-runs-specific-test.png"/>
            </a>
        </li>
    </ol>
    <h2>The default test's code</h2>
    <p>
        When you look at the default test's code you might notice that it looks a lot like a unit test.
        The e2e test is using jasmine and if you want to change that you can do that in the <code>protractor.conf.js</code> file.
    </p>
    <h3>app.e2e-spec.ts</h3>
    <p>
        Before each test it creates our <strong>Page Object</strong> <code>AppPage</code>.
        More about the page objects later but in short it's a design pattern to handle the DOM interactions or a sequence of actions.
        Then the test navigates to the app page and checks that the title text is as expected.
        Finally after each test it checks for any error messages in the console log.
    </p>
    <pre class="prettyprint lang-js linenums" data-start-visible="true">
<code>import { AppPage } from './app.po';
import { browser, logging } from 'protractor';

describe('workspace-project App', () => {
  let page: AppPage;

  beforeEach(() => {
    page = new AppPage();
  });

  it('should display welcome message', () => {
    page.navigateTo();
    expect(page.getTitleText()).toEqual('angular-e2e-example app is running!');
  });

  afterEach(async () => {
    // Assert that there are no errors emitted from the browser
    const logs = await browser.manage().logs().get(logging.Type.BROWSER);
    expect(logs).not.toContain(jasmine.objectContaining({
      level: logging.Level.SEVERE,
    } as logging.Entry));
  });
});
</code></pre>
    <h3>app.po.ts</h3>
    <p>
        In the AppPage's page object there is code that is only used on the app page.
        Which in this example is navigate to the app page and get the page's title text.
    </p>
    <pre class="prettyprint lang-js linenums" data-start-visible="true">
<code>import { browser, by, element } from 'protractor';

export class AppPage {
  navigateTo(): Promise&lt;unknown&gt; {
    return browser.get(browser.baseUrl) as Promise&lt;unknown&gt;;
  }

  getTitleText(): Promise&lt;string&gt; {
    return element(by.css('app-root .content span')).getText() as Promise&lt;string>;
  }
}
</code></pre>

    <h2>What are Page Objects?</h2>
    <p>
        Page object is a design pattern to write reusable e2e test code.
        As seen in the test above it has methods that navigates you to the page, or get an element and the text.
        It makes it simple to write more e2e tests because you can now easily reuse the functionality.
        For example if you write login and logout methods you can now use them in all the tests.
    </p>
    <p>
        Page object file names typically end with <code>.po.ts</code>.
    </p>
    <p>
        Some links about page objects for further reading:
        <br>
        <a href="https://github.com/SeleniumHQ/selenium/wiki/PageObjects">https://github.com/SeleniumHQ/selenium/wiki/PageObjects</a>
        <br>
        <a href="https://www.protractortest.org/#/page-objects">https://www.protractortest.org/#/page-objects</a>
        <br>
        <a href="https://martinfowler.com/bliki/PageObject.html">https://martinfowler.com/bliki/PageObject.html</a>
    </p>
    <h2>protractor.conf.js</h2>
    <p>
        This is the file that tells protractor what files to run, what browser to use and what testing framework and more.
        If you have very long tests you need to either change the <code>jasmineNodeOpts.defaultTimeoutInterval</code> variable.
        <br>
        <a href="https://1.bp.blogspot.com/-Ap_kgz9TCqo/X57EoEs6QxI/AAAAAAAAAXM/GtNxI9vRHVkny_juNY6s4gVXBqN2Kf-ZgCLcBGAsYHQ/s607/jasmine_defaultTimeoutInterval.png">
            <img alt="" border="0" width="200" data-original-height="531" data-original-width="607" src="https://1.bp.blogspot.com/-Ap_kgz9TCqo/X57EoEs6QxI/AAAAAAAAAXQ/a74KtOIWjfwv1xQ9jwhQtZ2S5aDXYXsowCPcBGAYYCw/s200/jasmine_defaultTimeoutInterval.png"/>
        </a>
        <br>
        Or pass the duration to the <code>it()</code> method.
    </p>
    <pre class="prettyprint lang-js linenums">
<code>it('a test', function() {
    // test code ...
}, 10000); // 10 seconds
</code></pre>
    <p>
        The protractor.conf.js file when generated with Angular 10 CLI:
    </p>
    <pre class="prettyprint lang-js linenums">
<code>// @ts-check
// Protractor configuration file, see link for more information
// https://github.com/angular/protractor/blob/master/lib/config.ts

const { SpecReporter, StacktraceOption } = require('jasmine-spec-reporter');

/**
 * @type { import("protractor").Config }
 */
exports.config = {
  allScriptsTimeout: 11000,
  specs: [
    './src/**/*.e2e-spec.ts'
  ],
  capabilities: {
    browserName: 'chrome'
  },
  directConnect: true,
  baseUrl: 'http://localhost:4200/',
  framework: 'jasmine',
  jasmineNodeOpts: {
    showColors: true,
    defaultTimeoutInterval: 30000,
    print: function() {}
  },
  onPrepare() {
    require('ts-node').register({
      project: require('path').join(__dirname, './tsconfig.json')
    });
    jasmine.getEnv().addReporter(new SpecReporter({
      spec: {
        displayStacktrace: StacktraceOption.PRETTY
      }
    }));
  }
};
</code></pre>
    <h1>Log in, handle an item and log out example</h1>
    <p>
        The example's source code an be found here: <a href="https://github.com/saaratrix/angular-e2e-example">https://github.com/saaratrix/angular-e2e-example</a>.
    </p>
    <p>
        Here is how the test looks like when using <code>npm run e2e</code>.
        <br>
        <img alt="" border="0" data-original-height="654" data-original-width="600" src="https://1.bp.blogspot.com/-tAyTNQcUn0w/X56sp4pPSFI/AAAAAAAAAXE/4_2EirsJSms_AcqLHzI8sm8nyfnb2bmrACPcBGAYYCw/s0/e2etest.gif"/>
    </p>
    <p>
        The test's spec file can be found here:
        <a href="https://github.com/saaratrix/angular-e2e-example/blob/main/e2e/src/app.e2e-spec.ts">https://github.com/saaratrix/angular-e2e-example/blob/main/e2e/src/app.e2e-spec.ts</a>.
        It does the following:
    </p>
    <ol>
        <li>First we login</li>
        <li>Then we create an item</li>
        <li>We assert that an item was created by checking item count.</li>
        <li>We delete an item</li>
        <li>We assert that the item was deleted by checking item count.</li>
        <li>We logout</li>
        <li>We assert that the login button is visible.</li>
    </ol>
    <p>
        By using the page object pattern we get very little code in the test itself and it's easy to follow each step.
    </p>
    <pre class="prettyprint lang-js linenums" data-start-visible="true">
<code>it('should login, create item, edit item, delete item and then log out.', () => {
    loginPage.login('saaratrix', '123456');
    appPage.createItem('item Nuu');
    // Used for asserts
    const currentItems = appPage.getItems();
    expect(currentItems.count()).toBe(1);
    appPage.updateItem('item Nuu', 'modified Nuu');
    appPage.deleteItem('modified Nuu');
    expect(currentItems.count()).toBe(0);
    loginPage.logout();

    expect(loginPage.getSignInButton().isDisplayed()).toBe(true);
});
</code></pre>

    <h1>Page object selectors</h1>
    <p>
        When creating the e2e tests you need to know either how to use CSS Selectors or XPath to get the elements but CSS Selectors are recommended because of their readability.
        And sometimes you might need to update the HTML to easier select a button, an input field etc.

        But you can test the CSS selector in the browser's developer tools by in the console writing <code>document.querySelector('selector query')</code>.
        And for XPath you can use <code>$x('xpath query')</code> in both Chrome and Firefox.
    </p>
    <h1>Tips & Tricks</h1>
    <ul>
        <li>
            Protractor is not executed synchronously.
            The test code may look synchronous but everytime you do a <code>browser.</code> call you're adding a promise to some internal chain.
            So for example if you want to calculate the time it takes between browser.wait() calls in a test you can use <code>.then()</code> on each promise.
        </li>
        <li>
            If you see the error message <strong>Invalid locator</strong> it's very likely you forgot to write <code>by.css()</code> or another method inside the <code>element()</code>.
        </li>
        <li>
            If you want to get the parent of an element you can do that with XPath (<code>by.xpath('..')</code>).
            <code>element(by.css('.child')).element(by.xpath('..'));</code>.
            I have tried to find a better way but this is the simplest way that I know of so far.
        </li>
    </ul>
</div>
</body>
</html>
